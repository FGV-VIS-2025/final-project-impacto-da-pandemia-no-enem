<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <title>Mapa do Brasil com Bolhas</title>
    <script>
        (function () {
        try {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
            document.documentElement.classList.add('dark-mode');
            }
        } catch (e) {}
        })();
    </script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            background-color: #ffffff;
            font-family: sans-serif;
        }

        #controls {
            text-align: center;
            margin: 20px;
        }

        .tooltip {
            position: absolute;
            padding: 6px;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            border-radius: 4px;
            pointer-events: none;
            visibility: hidden;
            white-space: pre-line;
        }

        .tooltip-barras {
            position: absolute;
            padding: 6px;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            border-radius: 4px;
            pointer-events: none;
            visibility: hidden;
            white-space: pre-line;
        }

        #container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px;
        }

        #mapa svg {
            width: 100%;
            height: auto;
        }

        #graficos {
            width: 30%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #mapa {
            width: 80%;
            max-width: 800px;
        }

        .bar-chart-container {
            width: 100%;
            height: 300px;
            padding: 1px;
            box-sizing: border-box;
            position: relative;
        }

        .bar-chart-title {
            text-align: center;
            font-size: 14px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .bar-chart-container svg {
            display: block;
            width: 100%;
            height: 100%;
        }

        .selected {
            stroke-width: 3px !important;
        }

    </style>

    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <header>
        <nav class="navbar">
            <ul>
              <li><a href="index.html">Introdu√ß√£o</a></li>
              <li><a href="project.html">Projeto</a></li>
              <li><a href="new_project.html">Novo Projeto</a></li>
              <li><a href="map-bubbles.html">Mapa de Bolhas</a></li>
              <li><a href="authors.html">Autores</a></li>
              <li><a href="https://github.com/FGV-VIS-2025/tarefa-4-impacto_da_pandemia_no_enem" target="_blank">GitHub</a></li>
            </ul>
            <select id="theme-select">
                <option value="auto">üåó Autom√°tico</option>
                <option value="light">üåû Claro</option>
                <option value="dark">üåô Escuro</option>
            </select> 
        </nav>
    </header>

    <h2 style="text-align: center;">Desempenho dos participantes do Enem no Brasil</h2>    

    <div id="tooltip" class="tooltip"></div>

    <div id="controls">
        <label for="yearSlider">Ano: <span id="selectedYear">2019</span></label><br>
        <input type="range" id="yearSlider" min="2019" max="2023" step="1" value="2019">
    </div>

    <div style="text-align: center; margin-top: 10px;">
        <button id="playButton">‚ñ∂Ô∏è Play</button>
    </div>

    <div style="
        position: absolute;
        bottom: 20px;
        left: 20px;
        background-color: rgba(255, 255, 255, 0.8);
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 0 5px rgba(0,0,0,0.3);
    ">
        <strong>N√≠vel de Participantes:</strong><br>
        <div style="display: flex; align-items: center; margin-top: 5px;">
            <div style="width: 8px; height: 8px; background-color: steelblue; border-radius: 50%; margin-right: 5px;"></div>
            <span style="font-size: 12px;">Muito Baixo (5k - 20k)</span>
        </div>
        <div style="display: flex; align-items: center; margin-top: 5px;">
            <div style="width: 15px; height: 15px; background-color: steelblue; border-radius: 50%; margin-right: 5px;"></div>
            <span style="font-size: 12px;">Baixo (30k - 60k)</span>
        </div>
        <div style="display: flex; align-items: center; margin-top: 5px;">
            <div style="width: 25px; height: 25px; background-color: steelblue; border-radius: 50%; margin-right: 5px;"></div>
            <span style="font-size: 12px;">M√©dio (100k - 120k)</span>
        </div>
        <div style="display: flex; align-items: center; margin-top: 5px;">
            <div style="width: 35px; height: 35px; background-color: steelblue; border-radius: 50%; margin-right: 5px;"></div>
            <span style="font-size: 12px;">Alto (200k - 280k)</span>
        </div>
        <div style="display: flex; align-items: center; margin-top: 5px;">
            <div style="width: 50px; height: 50px; background-color: steelblue; border-radius: 50%; margin-right: 5px;"></div>
            <span style="font-size: 12px;">Muito Alto (400k - 600k)</span>
        </div>
    </div>

    <div id="container">
        <div id="mapa"></div>
        <div id="graficos">
            <div class="bar-chart-container" id="chart-MT">
                <div class="bar-chart-title">Notas de Matem√°tica</div>
                <svg width="100%" height="90%"></svg>
            </div>
            <div class="bar-chart-container" id="chart-REDACAO">
                <div class="bar-chart-title">Notas de Reda√ß√£o</div>
                <svg width="100%" height="90%"></svg>
            </div>
        </div>
    </div>

    <script>
    /* Altera√ß√£o para outros temas */
    const themeSelect = document.getElementById('theme-select');

    // Aplica√ß√£o do tema escuro
    function applyTheme(theme) {
        const root = document.documentElement;
        root.classList.remove('dark-mode');

        if (theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            root.classList.add('dark-mode');
        }

        localStorage.setItem('theme', theme);
    }

    // Quando o usu√°rio muda a sele√ß√£o
    themeSelect.addEventListener('change', () => {
        applyTheme(themeSelect.value);
    });

    // Define o tema inicial ao carregar a p√°gina
    window.addEventListener('DOMContentLoaded', () => {
        const saved = localStorage.getItem('theme') || 'auto';
        themeSelect.value = saved;
        applyTheme(saved);
    });

    // Se o usu√°rio est√° no modo autom√°tico e o sistema muda de cor
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        const current = localStorage.getItem('theme');
        if (current === 'auto') {
            applyTheme('auto');
        }
    });

    window.addEventListener("DOMContentLoaded", () => {
        document.getElementById("variable1").selectedIndex = 0;
        document.getElementById("variable2").selectedIndex = 0;
    });  

    // Tamanho do SVG
    const width = 1000;
    const height = 700;

    // Proje√ß√£o centrada no Brasil
    const projection = d3.geoMercator()
        .center([-54, -15]) // centro aproximado do Brasil
        .scale(800)
        .translate([width / 2, height / 2 - 65]);

    // Caminho geogr√°fico
    const path = d3.geoPath().projection(projection);

    // Criar o SVG
    const svg = d3.select("#mapa")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

    // Grupos para o mapa e bolhas
    const mapaGroup = svg.append("g");
    const bolhasGroup = svg.append("g");

    let dadosNotas = {};

    let currentYear = "2019";

    // Carrega o mapa e os dados
    Promise.all([
        d3.json("https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/brazil-states.geojson"),
        d3.json("GeoJSON/estados_brasil.json"), // Seu arquivo com lat/long dos estados
        d3.json("GeoJSON/uf_qtd_e_notas.json") // Seu arquivo com dados do ENEM
    ]).then(([mapa, estados, enemData]) => {
        // Organiza os dados do ENEM por ano e estado
        enemData.forEach(item => {
            if (!dadosNotas[item.NU_ANO]) {
                dadosNotas[item.NU_ANO] = [];
            }
            dadosNotas[item.NU_ANO].push({
                UF: item.SG_UF_PROVA,
                QUANTIDADE_PESSOAS: item.QUANTIDADE_PESSOAS,
                NU_NOTA_CN: item.NU_NOTA_CN,
                NU_NOTA_CH: item.NU_NOTA_CH,
                NU_NOTA_LC: item.NU_NOTA_LC,
                NU_NOTA_MT: item.NU_NOTA_MT,
                NU_NOTA_REDACAO: item.NU_NOTA_REDACAO
            });
        });

        // Prepara os dados para as bolhas
        const datasets = {};
        
        // Para cada ano (2019-2023)
        for (let year = 2019; year <= 2023; year++) {
            datasets[year] = estados.map(estado => {
                const dadosEnem = dadosNotas[year].find(d => d.UF === estado.uf);
                return {
                    uf: estado.uf,
                    nome: estado.nome,
                    lat: estado.latitude,
                    lon: estado.longitude,
                    regiao: estado.regiao,
                    NUM_PARTICIPANTES: dadosEnem ? dadosEnem.QUANTIDADE_PESSOAS : 0
                };
            });
        }

        // Desenha o mapa
                mapaGroup
            .selectAll("path")
            .data(mapa.features)
            .join("path")
            .attr("d", path)
            .attr("fill", "#69b3a2")
            .attr("stroke", "#333")
            .attr("stroke-width", 1)
            .on("mouseover", function(event, d) {
                d3.select(this)
                    .attr("stroke-width", 3 + "px") 

            })
            .on("mouseout", function() {
                d3.select(this)
                    .attr("fill", "#69b3a2")
                    .attr("stroke", "#333")
                    .attr("stroke-width", 1);
            })
            .on("click", function (event, d) {
                    const current = d3.select(this);
                    const isSelected = current.classed("selected");

                    // Alterna a classe "selected"
                    current.classed("selected", !isSelected)
                        .transition().duration(300)
                        .attr("stroke-width", !isSelected ? 3 : 1); // Aumenta o contorno se selecionado, volta ao normal se desmarcado
                });

        // Escala de tamanho
        const maxVal = d3.max(Object.values(datasets).flat(), d => d.NUM_PARTICIPANTES);
        const escalaRaio = d3.scaleSqrt()
            .domain([0, maxVal])
            .range([0, 30]);

        const tooltip = d3.select("#tooltip");

        // Fun√ß√£o para atualizar bolhas
        function updateBubbles(data) {
            const bolhas = bolhasGroup.selectAll("circle")
                .data(data, d => d.uf);

            bolhas.join(
                enter => enter.append("circle")
                .attr("cx", d => {
                    const [x, y] = projection([d.lon, d.lat]);
                    d.originalX = x;  // guarda posi√ß√£o original
                    return x;
                })
                .attr("cy", d => {
                    const [x, y] = projection([d.lon, d.lat]);
                    d.originalY = y;
                    return y;
                })
                .attr("r", 0)
                .attr("fill", "steelblue")
                .attr("opacity", 0.75)
                .on("mouseover", function (event, d) {
                    tooltip
                    .style("visibility", "visible")
                    .text(`Estado: ${d.nome} (${d.uf})\nRegi√£o: ${d.regiao}\nN¬∫ de participantes: ${d.NUM_PARTICIPANTES.toLocaleString()}`);
                })
                .on("mousemove", function (event) {
                    tooltip
                    .style("top", (event.pageY - 10) + "px")
                    .style("left", (event.pageX + 10) + "px");
                })
                .on("mouseout", function () {
                    tooltip.style("visibility", "hidden");
                })
                .transition()
                .duration(500)
                .attr("r", d => escalaRaio(d.NUM_PARTICIPANTES)),

                update => update
                .on("mouseover", function (event, d) {
                    tooltip
                    .style("visibility", "visible")
                    .text(`Estado: ${d.nome} (${d.uf})\nRegi√£o: ${d.regiao}\nN¬∫ de participantes: ${d.NUM_PARTICIPANTES.toLocaleString()}`);
                })
                .on("mousemove", function (event) {
                    tooltip
                    .style("top", (event.pageY - 10) + "px")
                    .style("left", (event.pageX + 10) + "px");
                })
                .on("mouseout", function () {
                    tooltip.style("visibility", "hidden");
                })
                .transition()
                .duration(500)
                .attr("r", d => escalaRaio(d.NUM_PARTICIPANTES))
                .attr("cx", d => {
                    const [x, y] = projection([d.lon, d.lat]);
                    d.originalX = x;
                    d.originalY = y;
                    return x;
                })
                .attr("cy", d => d.originalY),

                exit => exit
                .transition()
                .duration(500)
                .attr("r", 0)
                .remove()
            );

            // Atualiza os gr√°ficos de barras
            updateBarCharts(dadosNotas[currentYear]);
            
            // Inicia a flutua√ß√£o ap√≥s atualiza√ß√£o
            setTimeout(flutuarBolhas, 600);
        }

        function flutuarBolhas() {
            bolhasGroup.selectAll("circle")
                .transition()
                .duration(2000)
                .ease(d3.easeSinInOut)
                .attr("cx", d => d.originalX + (Math.random() - 0.5) * 10) 
                .attr("cy", d => d.originalY + (Math.random() - 0.5) * 10)
                .on("end", flutuarBolhas); // repete o ciclo
        }

        function atualizarTooltipSeHover() {
            const hovered = d3.select("circle:hover").data(); // pega os dados da bolha sob o mouse, se houver
            if (hovered.length > 0) {
                const d = hovered[0];
                tooltip
                    .style("visibility", "visible")
                    .text(`Estado: ${d.nome} (${d.uf})\nRegi√£o: ${d.regiao}\nN¬∫ de participantes: ${d.NUM_PARTICIPANTES.toLocaleString()}`);
            }
        }

        function updateBarCharts(dadosNotasAno) {
            const variaveis = [
                {id: "MT", nome: "NU_NOTA_MT", titulo: "Matem√°tica"},
                {id: "REDACAO", nome: "NU_NOTA_REDACAO", titulo: "Reda√ß√£o"}
            ];
            
            // Ordena por UF para consist√™ncia
            dadosNotasAno.sort((a, b) => a.UF.localeCompare(b.UF));
            
            variaveis.forEach(v => {
                const container = d3.select(`#chart-${v.id}`);
                const svg = container.select("svg");
                svg.selectAll("*").remove();
                
                const margin = {top: 20, right: 20, bottom: 170, left: 70};
                const containerWidth = container.node().getBoundingClientRect().width;
                const containerHeight = container.node().getBoundingClientRect().height;
                
                const width = containerWidth - margin.left - margin.right;
                const height = containerHeight - margin.top - margin.bottom;
                
                svg.attr("width", containerWidth)
                .attr("height", containerHeight);
                
                const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
                
                // Escalas
                const x = d3.scaleBand()
                    .domain(dadosNotasAno.map(d => d.UF))
                    .range([0, width])
                    .padding(0.2);
                
                const y = d3.scaleLinear()
                    .domain([0, d3.max(dadosNotasAno, d => d[v.nome]) * 1.1])
                    .nice()
                    .range([height, 0]);
                
                // Barras
                g.selectAll(".bar")
                    .data(dadosNotasAno)
                    .enter().append("rect")
                    .attr("class", "bar")
                    .attr("x", d => x(d.UF))
                    .attr("y", d => y(d[v.nome]))
                    .attr("width", x.bandwidth())
                    .attr("height", d => height - y(d[v.nome]))
                    .attr("fill", v.id === "MT" ? "#B22222" : "#DAA520") 
                    .attr("fill-opacity", 0.8)
                    .on("mouseover", function(event, d) {
                        d3.select("#tooltip-barras")
                            .style("visibility", "visible")
                            .html(`Estado: ${d.UF}
                                M√©dia de ${v.titulo}: ${d[v.nome].toFixed(1)}
                                N¬∞ de participantes: ${d.QUANTIDADE_PESSOAS.toLocaleString()}
                            `);
                    })
                    .on("mousemove", function(event) {
                        d3.select("#tooltip-barras")
                            .style("top", (event.pageY - 10) + "px")
                            .style("left", (event.pageX + 10) + "px");
                    })
                    .on("mouseout", function() {
                        d3.select("#tooltip-barras").style("visibility", "hidden");
                    });
                
                // Eixo X com rota√ß√£o
                g.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x))
                    .selectAll("text")
                    .attr("transform", "rotate(-45)")
                    .style("text-anchor", "end")
                    .style("font-size", "10px")
                    .attr("dx", "-0.5em")
                    .attr("dy", "0.5em");

                // T√≠tulo do eixo X
                g.append("text")
                    .attr("transform", `translate(${width/2}, ${height + margin.bottom - 130})`)
                    .style("text-anchor", "middle")
                    .style("font-size", "12px")
                    .style("font-weight", "bold")
                    .text("Estado");    
                
                // Eixo Y
                g.append("g")
                    .call(d3.axisLeft(y).ticks(5))
                    .style("font-size", "10px");
                
                // Adiciona t√≠tulo do eixo Y
                g.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -margin.left + 10)
                    .attr("x", -height / 2)
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .style("font-size", "12px")
                    .style("font-weight", "bold")
                    .text("Nota M√©dia");
            });
        }

        // Slider
        d3.select("#yearSlider").on("input", function () {
            currentYear = this.value;
            d3.select("#selectedYear").text(currentYear);
            updateBubbles(datasets[currentYear]);
        });

        // L√≥gica para o bot√£o play
        let isPlaying = false;
        let animationInterval = null;

        const playButton = document.getElementById('playButton');
        const yearSlider = document.getElementById('yearSlider');

        playButton.addEventListener('click', () => {
            if (isPlaying) {
                // Pause
                clearInterval(animationInterval);
                playButton.textContent = '‚ñ∂Ô∏è Play';
                isPlaying = false;
            } else {
                // Play
                isPlaying = true;
                playButton.textContent = '‚è∏Ô∏è Pause';
                
                animationInterval = setInterval(() => {
                    // Avan√ßa o ano
                    let nextYear = parseInt(currentYear) + 1;
                    if (nextYear > 2023) nextYear = 2019;
                    
                    currentYear = nextYear.toString();
                    
                    yearSlider.value = currentYear;
                    document.getElementById('selectedYear').textContent = currentYear;
                    updateBubbles(datasets[currentYear]);
                    atualizarTooltipSeHover();
                }, 1500);
            }
        });

        // Inicializa com 2019
        updateBubbles(datasets["2019"]);
    });
    </script>

    <div id="tooltip-barras" class="tooltip-barras"></div>

</body>
</html>